<link rel="stylesheet" href="/css/community/view.css">
<script>

    document.addEventListener('DOMContentLoaded', function () {
        const path = location.pathname;
        const pathSegments = path.split('/');  // URL을 "/" 기준으로 나눔
        const lastSegment = pathSegments[pathSegments.length - 1]; // URL의 마지막 경로 추출

        // 모든 섹션 숨김
        const freeboardSection = document.getElementById("freeboardSection");
        const noticeSection = document.getElementById("noticeSection");
        const adnoticeSection = document.getElementById("adnoticeSection");

        if (freeboardSection && noticeSection && adnoticeSection) {
            freeboardSection.style.display = "none";
            noticeSection.style.display = "none";
            adnoticeSection.style.display = "none";

            // 정확한 URL 경로 판별
            switch (true) {
                case path.includes("/community/freeboard"):
                    freeboardSection.style.display = "block";
                    break;
                case path.includes("/community/notice"):
                    noticeSection.style.display = "block";
                    break;
                case path.includes("/admission/adnotice"):
                    adnoticeSection.style.display = "block";
                    break;
            }
        }

        // 댓글 목록 및 작성 폼 처리 함수
        const loadComments = (parentId, commentList) => {
            fetch(`/comment/list?parent=${parentId}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.length) {
                        commentList.innerHTML = '<p class="empty">등록된 댓글이 없습니다.</p>';
                    } else {
                        commentList.innerHTML = ''; // 기존 댓글 목록 초기화
                        data.forEach(comment => {
                            const article = `<article data-cno="${comment.cno}">
                                    <span class="nick">${comment.user.name}</span>
                                    <span class="date">${comment.wdate}</span>
                                    <p class="content">${comment.content}</p>
                                    <div>
                                        <a href="#" class="remove">삭제</a>
                                        <a href="#" class="modify">수정</a>
                                    </div>
                                </article>`;
                            commentList.insertAdjacentHTML('beforeend', article);
                        });
                    }
                })
                .catch(err => {
                    console.log("❌ 댓글 목록 불러오기 실패:", err);
                });
        };

        const handleCommentSubmit = (formComment, commentList) => {
            formComment.addEventListener('submit', async function (e) {
                e.preventDefault();

                const jsonData = {
                    "parent": this.querySelector('input[name="parent"]').value,
                    "writer": this.querySelector('input[name="writer"]').value,
                    "content": this.querySelector('textarea[name="comment"]').value
                };

                try {
                    const response = await fetch('/comment/write', {
                        method: 'POST',
                        headers: { "Content-type": "application/json" },
                        body: JSON.stringify(jsonData)
                    });

                    const textData = await response.text();
                    const data = JSON.parse(textData);

                    const article = `<article data-cno="${data.cno}">
                            <span class="name">${data.user.name}</span>
                            <span class="date">${data.wdate}</span>
                            <p class="content">${data.content}</p>
                            <div>
                                <a href="#" class="remove">삭제</a>
                                <a href="#" class="modify">수정</a>
                            </div>
                        </article>`;

                    this.querySelector('textarea[name="comment"]').value = '';
                    commentList.insertAdjacentHTML('beforeend', article);
                } catch (error) {
                    console.log("❌ 댓글 작성 요청 실패:", error);
                }
            });
        };

        const handleCommentDelete = (commentList) => {
            commentList.addEventListener('click', async function (e) {
                if (e.target.classList.contains('remove')) {
                    e.preventDefault();

                    const article = e.target.closest('article');
                    const cno = article.dataset.cno;

                    if (!confirm("정말 삭제하시겠습니까?")) return;

                    try {
                        const response = await fetch(`/comment/delete?cno=${cno}`, {
                            method: 'POST',
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ cno: cno })
                        });

                        const result = await response.text();
                        if (result === "success") {
                            article.remove();
                        } else {
                            alert("삭제 실패");
                        }
                    } catch (error) {
                        console.log("❌ 댓글 삭제 실패:", error);
                    }
                }
            });
        };

        // 프리보드 섹션에서 댓글 처리
        const freeboardFormComment = document.querySelector('#freeboardSection form[name="formComment"]');
        const freeboardCommentList = document.querySelector('#freeboardSection .commentList');
        if (freeboardFormComment && freeboardCommentList) {
            const parentFreeboard = freeboardFormComment.querySelector('input[name="parent"]').value;
            loadComments(parentFreeboard, freeboardCommentList);
            handleCommentSubmit(freeboardFormComment, freeboardCommentList);
            handleCommentDelete(freeboardCommentList);
        }

        // 노티스 섹션에서 댓글 처리
        const noticeFormComment = document.querySelector('#noticeSection form[name="formComment"]');
        const noticeCommentList = document.querySelector('#noticeSection .commentList');
        if (noticeFormComment && noticeCommentList) {
            const parentNotice = noticeFormComment.querySelector('input[name="parent"]').value;
            loadComments(parentNotice, noticeCommentList);
            handleCommentSubmit(noticeFormComment, noticeCommentList);
            handleCommentDelete(noticeCommentList);
        }

        // 애드노티스 섹션에서 댓글 처리
        const adnoticeFormComment = document.querySelector('#adnoticeSection form[name="formComment"]');
        const adnoticeCommentList = document.querySelector('#adnoticeSection .commentList');
        if (adnoticeFormComment && adnoticeCommentList) {
            const parentAdnotice = adnoticeFormComment.querySelector('input[name="parent"]').value;
            loadComments(parentAdnotice, adnoticeCommentList);
            handleCommentSubmit(adnoticeFormComment, adnoticeCommentList);
            handleCommentDelete(adnoticeCommentList);
        }
    });

</script>

<div id="freeboardSection">
<table border="0">
    <tr>
        <th>제목</th>
        <td><input type="text" name="title" th:value="${articleDTO.title}" readonly/></td>
    </tr>
    <tr>
        <th>작성자</th>
        <td><input type="text" name="writer" th:value="${articleDTO.user.name}" readonly/></td>
    </tr>
    <tr th:if="${articleDTO.file > 0}">
        <th>파일</th>
        <td>
            <th:block th:each="file:${articleDTO.files}">
                <p><a th:href="@{/file/download(fno=${file.fno})}">[[${file.oName}]]</a>&nbsp;<span>[[${file.download}]]</span>회 다운로드</p>
            </th:block>
        </td>
    </tr>
    <tr>
        <th>내용</th>
        <td>
            <textarea name="content" readonly>[[${articleDTO.content}]]</textarea>
        </td>
    </tr>
</table>

<div>
    <!-- 로그인한 사용자만 삭제 버튼 표시 -->
    <a th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.user.uid == articleDTO.user.uid}"
       th:href="@{/community/freeboard/delete(no=${articleDTO.no})}" class="btn btnRemove">삭제</a>
    <a th:href="@{/community/freeboard/modify(no=${articleDTO.no})}" class="btn btnModify">수정</a>
    <a th:href="@{/community/freeboard}" class="btn btnList">목록</a>
</div>

<!-- 댓글목록 -->
<section class="commentList">
    <h3>댓글목록</h3>
    <p class="empty">등록된 댓글이 없습니다.</p>
</section>

<!-- 댓글 쓰기-->
<section class="commentForm">
    <h3>댓글쓰기</h3>

    <!-- 로그인하지 않은 경우 안내 메시지 -->
    <div th:if="${not #authorization.expression('isAuthenticated()')}">
        <p>댓글을 작성하려면 <a th:href="@{/user/login}">로그인</a>하세요.</p>
    </div>


    <form name="formComment" method="post">
        <input type="hidden" name="writer" th:value="${#authorization.expression('isAuthenticated()') ? #authentication.principal.user.uid : ''}">
        <input type="hidden" name="parent" th:value="${articleDTO.no}">
        <textarea name="comment" placeholder="댓글내용 입력"></textarea>
        <div>
            <a href="#" class="btn btnCancel">취소</a>
            <input type="submit" value="작성완료" class="btn btnComplete"/>
        </div>
    </form>
</section>
</div>


<div id="noticeSection">
    <table border="0">
        <tr>
            <th>제목</th>
            <td><input type="text" name="title" th:value="${articleDTO.title}" readonly/></td>
        </tr>
        <tr>
            <th>작성자</th>
            <td><input type="text" name="writer" th:value="${articleDTO.user.name}" readonly/></td>
        </tr>
        <tr th:if="${articleDTO.file > 0}">
            <th>파일</th>
            <td>
                <th:block th:each="file:${articleDTO.files}">
                    <p><a th:href="@{/file/download(fno=${file.fno})}">[[${file.oName}]]</a>&nbsp;<span>[[${file.download}]]</span>회 다운로드</p>
                </th:block>
            </td>
        </tr>
        <tr>
            <th>내용</th>
            <td>
                <textarea name="content" readonly>[[${articleDTO.content}]]</textarea>
            </td>
        </tr>
    </table>

    <div>
        <!-- 로그인한 사용자만 삭제 버튼 표시 -->
        <a th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.user.uid == articleDTO.user.uid}"
           th:href="@{/community/notice/delete(no=${articleDTO.no})}" class="btn btnRemove">삭제</a>
        <a th:href="@{/community/notice/modify(no=${articleDTO.no})}" class="btn btnModify">수정</a>
        <a th:href="@{/community/notice}" class="btn btnList">목록</a>
    </div>

    <!-- 댓글목록 -->
    <section class="commentList">
        <h3>댓글목록</h3>
        <p class="empty">등록된 댓글이 없습니다.</p>
    </section>

    <!-- 댓글 쓰기-->
    <section class="commentForm">
        <h3>댓글쓰기</h3>

        <!-- 로그인하지 않은 경우 안내 메시지 -->
        <div th:if="${not #authorization.expression('isAuthenticated()')}">
            <p>댓글을 작성하려면 <a th:href="@{/user/login}">로그인</a>하세요.</p>
        </div>


        <form name="formComment" method="post">
            <input type="hidden" name="writer" th:value="${#authorization.expression('isAuthenticated()') ? #authentication.principal.user.uid : ''}">
            <input type="hidden" name="parent" th:value="${articleDTO.no}">
            <textarea name="comment" placeholder="댓글내용 입력"></textarea>
            <div>
                <a href="#" class="btn btnCancel">취소</a>
                <input type="submit" value="작성완료" class="btn btnComplete"/>
            </div>
        </form>
    </section>
</div>


<div id="adnoticeSection">
    <table border="0">
        <tr>
            <th>제목</th>
            <td><input type="text" name="title" th:value="${articleDTO.title}" readonly/></td>
        </tr>
        <tr>
            <th>작성자</th>
            <td><input type="text" name="writer" th:value="${articleDTO.user.name}" readonly/></td>
        </tr>
        <tr th:if="${articleDTO.file > 0}">
            <th>파일</th>
            <td>
                <th:block th:each="file:${articleDTO.files}">
                    <p><a th:href="@{/file/download(fno=${file.fno})}">[[${file.oName}]]</a>&nbsp;<span>[[${file.download}]]</span>회 다운로드</p>
                </th:block>
            </td>
        </tr>
        <tr>
            <th>내용</th>
            <td>
                <textarea name="content" readonly>[[${articleDTO.content}]]</textarea>
            </td>
        </tr>
    </table>

    <div>
        <!-- 로그인한 사용자만 삭제 버튼 표시 -->
        <a th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.user.uid == articleDTO.user.uid}"
           th:href="@{/admission/adnotice/delete(no=${articleDTO.no})}" class="btn btnRemove">삭제</a>
        <a th:href="@{/admission/adnotice/modify(no=${articleDTO.no})}" class="btn btnModify">수정</a>
        <a th:href="@{/admission/adnotice}" class="btn btnList">목록</a>
    </div>

    <!-- 댓글목록 -->
    <section class="commentList">
        <h3>댓글목록</h3>
        <p class="empty">등록된 댓글이 없습니다.</p>
    </section>

    <!-- 댓글 쓰기-->
    <section class="commentForm">
        <h3>댓글쓰기</h3>

        <!-- 로그인하지 않은 경우 안내 메시지 -->
        <div th:if="${not #authorization.expression('isAuthenticated()')}">
            <p>댓글을 작성하려면 <a th:href="@{/user/login}">로그인</a>하세요.</p>
        </div>


        <form name="formComment" method="post">
            <input type="hidden" name="writer" th:value="${#authorization.expression('isAuthenticated()') ? #authentication.principal.user.uid : ''}">
            <input type="hidden" name="parent" th:value="${articleDTO.no}">
            <textarea name="comment" placeholder="댓글내용 입력"></textarea>
            <div>
                <a href="#" class="btn btnCancel">취소</a>
                <input type="submit" value="작성완료" class="btn btnComplete"/>
            </div>
        </form>
    </section>
</div>


</div>
</article>
</section>
</main>